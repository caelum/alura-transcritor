<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Transcritor Alura</title>

    <link rel="stylesheet" href="lib/simplemde.min.css">
    <link rel="stylesheet" href="lib/darkroom.css">
    <link rel="stylesheet" href="src/transcritor.css">

    <script src="lib/simplemde.min.js"></script>
    <script src="lib/slug.js"></script>
    <script src="lib/base64img.js"></script>
    <script src="lib/capture-video-frame.js"></script>

</head>
<body data-layout="umatela">
    
    <div id="video"></div>
    <div id="editor"><textarea></textarea></div>
    <div id="image-editor"></div>

    <script>
    // pega parametros na URL
    var CONFIG = {};
    (function(){
        var url = new URL(window.location.href);
        CONFIG.videoUrl = url.searchParams.get('video');
        CONFIG.admin = url.searchParams.get('admin');
        CONFIG.task = url.searchParams.get('task');
        CONFIG.aula = url.searchParams.get('aula');
        CONFIG.posicao = url.searchParams.get('posicao');
        CONFIG.course = CONFIG.task.match('/course\/([^\/]+)/')[1];
        CONFIG.courseId = CONFIG.admin.match('/course\/([^\/]+)/')[1];
        CONFIG.taskId = CONFIG.task.substring(CONFIG.task.lastIndexOf('/')+1)
        CONFIG.uploadURL = 'https://s3.amazonaws.com/caelum-online-public';
    })();

    // constroi o video player
    document.querySelector('#video').innerHTML = `<video src="${CONFIG.videoUrl}" controls crossorigin="anonymous"></video>`;
    </script>

    <script>
    (function(){
        video = document.querySelector('video');

        // editor
        editor = new SimpleMDE({
            autofocus: true,
            autosave: {
                enabled: true,
                delay: 5000,
                uniqueId: CONFIG.taskId
            },
            insertTexts: {
                link: ['<a href="http://" target="_blank">', '</a>']
            },
            spellChecker: false,
            showIcons: ['code'],
            shortcuts: {
                'toggleSideBySide': 'F11',
                'toggleFullScreen': null
            },
            status: [
                {
                    defaultValue: function(el) {
                        el.innerHTML = `<a href="${CONFIG.admin}" target="_blank">Admin</a>`;
                    }
                },
                {
                    className: "ajuda",
                    defaultValue: function(el) {
                        el.innerHTML = "Ajuda? F12";
                    }
                },
                {
                    className: "status-pbrate",
                    defaultValue: function(el) {
                        el.innerHTML = "1x";
                    }
                },
                {
                    className: "status-curtime",
                    defaultValue: function(el) {
                        el.innerHTML = "0:00";
                    }
                },
            ],
        });

        editor.codemirror.addKeyMap({
            'Esc': () => video.paused? video.play() : video.pause(),

            'F1': () => video.currentTime -= 1,
            'F2': () => video.currentTime += 1,

            'F3': () => changePlaybackRate(video.playbackRate + 0.1),
            'F4': () => changePlaybackRate(video.playbackRate - 0.1),
            'F5': () => changePlaybackRate(1.0),

            'F6': () => videoToSameWindow(),
            'F7': () => videoToNewWindow(),

            'F8': () => insertText(`{${secToVideoTimestamp(video.currentTime, true)}}`),
            'F9': screenshot,

            'F12': () => alert(
                `Atalhos:
                Esc - Play/Pause
                F1 - Volta 1s
                F2 - Avança 1s

                F3 - Aumenta velocidade
                F4 - Diminui velocidade
                F5 - Velocidade normal 1x
                
                F6 - Layout 1 tela
                F7 - Layout 2 telas

                F8 - Insere timestamp no editor
                F9 - Screenshot

                F12 - Ajuda

                Ctrl+B - Negrito
                Ctrl+I - Itálico
                Ctrl+Alt+C - Insere código
                Ctrl+K - Insere link
            `)
        });

        function screenshot() {
            video.pause();
            
            alt = prompt('Tirando screenshot. Qual o alt da imagem?');
            var slug = window.slug(alt, {lower: true}).split('-').splice(0, 3).join('-'); // 3 palavras

            // conta o numero de screenshots nessa task
            var key = `screen_${CONFIG.taskId}`;
            var contador = parseInt(localStorage.getItem(key) || 0) + 1;
            localStorage.setItem(key, contador);

            // padrao: 1.2_001_at.jpg
            // FEIO: global pra chamar no editor
            filename = `${CONFIG.aula}.${CONFIG.posicao}_${("" + (contador + 1000)).substr(1)}_${slug}.jpg`;

            // salva o screenshot
            var frame = captureVideoFrame(video, 'jpeg');
            
            // dispara editor de crop
            var imgeditor = document.querySelector('#image-editor');
            imgeditor.innerHTML = '';
            var img = new Image();
            img.src = frame.dataUri;
            img.id = 'darkroom';
            imgeditor.appendChild(img);
            imgeditor.classList.add('show');

            new Darkroom('#darkroom', {
                plugins: {
                    save: false,
                    rotate: false
                  },
                  initialize: function() {
                    var cropPlugin = this.plugins['crop'];
                    cropPlugin.requireFocus();
                }
            });
        };

        function videoToNewWindow() {
            changeLayout('duastelas');
            janelaAuxiliar = window.open("", "Vídeo", "toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=1280,height=720,top=0,left=0");
            janelaAuxiliar.document.body.innerHTML = `
                <style>
                html, body { margin: 0 }
                video {width: 100%; height: 100%;}
                </style>
                ${document.getElementById('video').innerHTML}
            `;

            // sync
            video = janelaAuxiliar.document.querySelector('video');
            janelaAuxiliar.document.querySelector('video').currentTime = document.querySelector('video').currentTime;
            janelaAuxiliar.document.querySelector('video').playbackRate = document.querySelector('video').playbackRate;
        }

        function videoToSameWindow() {
            changeLayout('umatela');

            //sync
            video = document.querySelector('video');
            document.querySelector('video').currentTime = janelaAuxiliar.document.querySelector('video').currentTime;
            document.querySelector('video').playbackRate = janelaAuxiliar.document.querySelector('video').playbackRate;

            janelaAuxiliar.close();
        }

        function changePlaybackRate(valor){
            video.playbackRate = valor;
            document.querySelector('.status-pbrate').textContent = `${parseInt(video.playbackRate * 10) / 10.0}x`;
        }

        function secToVideoTimestamp(time, showMilliseconds) {
            var min = parseInt(parseInt(time) / 60);
            var sec = parseInt(parseInt(time) % 60);
            var mil = parseInt(time % 1 * 10);
            return (`${min}:${sec < 10? '0'+sec: sec}`) + (showMilliseconds? `.${mil}` : '');
        }

        function changeLayout(name) {
            document.body.style.display = 'none';
            document.body.setAttribute('data-layout', name);
            requestAnimationFrame(() => {
                document.body.style.display = '';
                editor.codemirror.refresh();
            });
        }

        var statuscurtime = document.querySelector('.status-curtime');
        video.ontimeupdate = () => statuscurtime.textContent = secToVideoTimestamp(video.currentTime, false);
    })();

    // append no editor
    function insertText(text) {
        editor.codemirror.replaceSelection(text);
    }
    </script>

    <script src="lib/fabric.js"></script>
    <script src="lib/darkroom.js"></script>

    <script>
        Darkroom.plugins['finish'] = Darkroom.Plugin.extend({

        defaults: {
            callback: function() {
                // pega data url
                var data = document.querySelector('.lower-canvas').toDataURL('jpeg');

                // limpa editor
                this.darkroom.selfDestroy();
                document.querySelector('#image-editor').classList.remove('show');

                // download
                var a = document.createElement('a');
                a.setAttribute('href', data);
                a.setAttribute('download', filename);
                a.click();

                // insere no markdown
                // padrao: https://s3.amazonaws.com/caelum-online-public/234-illustrator-finalizacao-e-apresentacao-de-personagem/1.2_01_movendo-o-elemento.png
                insertText(`\n![${alt}](${CONFIG.uploadURL}/${CONFIG.courseId}-${CONFIG.course}/${filename})\n`);
            }
        },

        initialize: function InitializeDarkroomSavePlugin() {
            var buttonGroup = this.darkroom.toolbar.createButtonGroup();

            this.destroyButton = buttonGroup.createButton({
                image: 'save'
            });

            this.destroyButton.addEventListener('click', this.options.callback.bind(this));
            },
        });
    </script>

</body>
</html>